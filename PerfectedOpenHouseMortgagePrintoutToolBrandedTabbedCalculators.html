<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ken Morgan's Home Financing Calculator</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF & AutoTable for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    
    <!-- Google Fonts: Inter and Playfair Display for the PDF -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to enhance the look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .input-label {
            font-weight: 500;
            color: #4a5568; /* Gray-700 */
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e0; /* Gray-300 */
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4299e1; /* Blue-400 */
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
        }
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d2d6dc;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .slider:hover {
            opacity: 1;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3182ce; /* Blue-600 */
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3182ce; /* Blue-600 */
            cursor: pointer;
        }
        .summary-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #2c5282; /* Blue-800 */
        }
        .summary-label {
            font-weight: 500;
            color: #718096; /* Gray-500 */
        }
        .btn-primary {
            background-color: #3182ce;
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2b6cb0;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            color: #4a5568;
        }
        .tab.active {
            color: #2c5282;
            border-bottom-color: #3182ce;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <!-- This container will be dynamically filled with your images from the 'headerImages' array in the script below -->
            <div id="header-images-container" class="flex justify-between items-center w-full mb-4"></div>
            
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mt-8">Ken Morgan's Home Financing Toolkit</h1>
            <p class="text-lg text-gray-600 mt-2">A suite of tools to help you plan your home purchase.</p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-8 border-b border-gray-300">
            <nav class="flex flex-wrap -mb-px justify-center" id="tab-nav">
                <button class="tab active" data-tab="payment-calculator">Payment Calculator</button>
                <button class="tab" data-tab="affordability-calculator">Affordability Calculator</button>
                <button class="tab" data-tab="closing-costs">Closing Cost Estimator</button>
                <button class="tab" data-tab="amortization-schedule">Amortization Schedule</button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="tab-content-container">
            <!-- Payment Calculator Tab -->
            <div id="payment-calculator" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <!-- Left Column: Inputs -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="card p-6">
                            <h2 class="text-2xl font-bold text-gray-700 mb-4">Property & Loan Details</h2>
                            <div class="space-y-2 mb-4">
                                <label for="pc_propertyAddress" class="input-label">Property Address</label>
                                <input type="text" id="pc_propertyAddress" class="input-field" placeholder="e.g., 123 Main St, Hamilton, ON">
                            </div>
                            <div class="space-y-2 mb-4">
                                <label for="pc_purchasePrice" class="input-label">Purchase Price</label>
                                <input type="number" id="pc_purchasePrice" class="input-field" value="750000" step="5000">
                                <input type="range" id="pc_purchasePriceSlider" class="slider" min="100000" max="2500000" step="5000" value="750000">
                            </div>
                            <div class="space-y-2 mb-4">
                                <div class="flex justify-between items-center">
                                    <label for="pc_downPayment" class="input-label">Down Payment (%)</label>
                                    <span id="pc_downPaymentValue" class="font-semibold text-gray-700"></span>
                                </div>
                                <input type="range" id="pc_downPayment" class="slider" min="5" max="50" step="0.5" value="20">
                                <p id="pc_minDownPaymentText" class="text-sm text-gray-500"></p>
                            </div>
                            <div class="space-y-2 mb-4">
                                <label for="pc_interestRate" class="input-label">Interest Rate (%)</label>
                                <input type="number" id="pc_interestRate" class="input-field" value="5.25" step="0.01">
                            </div>
                            <div class="space-y-2">
                                <label for="pc_amortization" class="input-label">Amortization Period</label>
                                <select id="pc_amortization" class="input-field">
                                    <option value="25">25 Years</option>
                                    <option value="30">30 Years</option>
                                    <option value="20">20 Years</option>
                                    <option value="15">15 Years</option>
                                </select>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h2 class="text-2xl font-bold text-gray-700 mb-4">Additional Costs & Report</h2>
                            <div class="space-y-2 mb-4">
                                <label for="pc_propertyTaxes" class="input-label">Annual Property Taxes</label>
                                <input type="number" id="pc_propertyTaxes" class="input-field" value="3600" step="100">
                            </div>
                            <div class="space-y-2 mb-4">
                                <label for="pc_monthlyUtilities" class="input-label">Estimated Monthly Utilities</label>
                                <input type="number" id="pc_monthlyUtilities" class="input-field" value="150" step="10">
                            </div>
                            <div class="space-y-2 mb-4">
                                <label for="pc_condoFees" class="input-label">Monthly Condo/Maintenance Fees</label>
                                <input type="number" id="pc_condoFees" class="input-field" value="0" step="10">
                            </div>
                             <div class="mt-6 text-center">
                                <button id="pc_generateReportBtn" class="btn-primary w-full">Generate Printable Report</button>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column: Results -->
                    <div class="lg:col-span-3 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="card p-6 text-center">
                                <h3 class="summary-label">Total Monthly Payment</h3>
                                <p id="pc_totalMonthlyPayment" class="summary-value">$0</p>
                            </div>
                            <div class="card p-6 text-center">
                                <h3 class="summary-label">Required Annual Income</h3>
                                <p id="pc_requiredIncome" class="summary-value">$0</p>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                                <div class="space-y-4">
                                    <h3 class="text-2xl font-bold text-gray-700 mb-4">Financial Breakdown</h3>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Down Payment:</span>
                                        <span id="pc_downPaymentAmount" class="font-semibold text-gray-800">$0</span>
                                    </div>
                                     <div class="flex justify-between">
                                        <span class="text-gray-600">Initial Mortgage:</span>
                                        <span id="pc_initialMortgage" class="font-semibold text-gray-800">$0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">CMHC Insurance:</span>
                                        <span id="pc_cmhcPremium" class="font-semibold text-gray-800">$0</span>
                                    </div>
                                    <div class="flex justify-between border-t-2 border-dashed pt-2">
                                        <span class="font-bold text-gray-700">Total Financed Amount:</span>
                                        <span id="pc_totalFinanced" class="font-bold text-lg text-blue-700">$0</span>
                                    </div>
                                     <hr class="my-4">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Principal & Interest:</span>
                                        <span id="pc_piPayment" class="font-semibold text-gray-800">$0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Monthly Property Tax:</span>
                                        <span id="pc_monthlyTaxes" class="font-semibold text-gray-800">$0</span>
                                    </div>
                                     <div class="flex justify-between">
                                        <span class="text-gray-600">Monthly Condo Fees:</span>
                                        <span id="pc_monthlyCondo" class="font-semibold text-gray-800">$0</span>
                                    </div>
                                </div>
                                <div>
                                    <canvas id="paymentChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Affordability Calculator Tab -->
            <div id="affordability-calculator" class="tab-content">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Your Financial Details</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="ac_annualIncome" class="input-label">Gross Annual Income</label>
                                <input type="number" id="ac_annualIncome" class="input-field" value="100000">
                            </div>
                             <div>
                                <label for="ac_monthlyDebts" class="input-label">Total Monthly Debts (Car, Credit Cards, etc.)</label>
                                <input type="number" id="ac_monthlyDebts" class="input-field" value="500">
                            </div>
                            <div>
                                <label for="ac_downPaymentAmount" class="input-label">Available Down Payment</label>
                                <input type="number" id="ac_downPaymentAmount" class="input-field" value="50000">
                            </div>
                             <div class="mt-6 text-center">
                                <button id="ac_generateReportBtn" class="btn-primary w-full">Generate Affordability Report</button>
                            </div>
                        </div>
                    </div>
                     <div class="card p-6 text-center flex flex-col justify-center">
                        <h3 class="summary-label">Estimated Maximum Purchase Price</h3>
                        <p id="ac_maxPurchasePrice" class="summary-value text-green-600">$0</p>
                        <p class="text-gray-500 mt-2">Based on a 5.25% stress test rate, 39% GDS, and 44% TDS ratios.</p>
                    </div>
                 </div>
            </div>

            <!-- Closing Costs Tab -->
            <div id="closing-costs" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Closing Cost Details</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="cc_purchasePrice" class="input-label">Purchase Price</label>
                                <input type="number" id="cc_purchasePrice" class="input-field" value="750000">
                            </div>
                            <div class="flex items-center space-x-4">
                                <label for="cc_firstTimeBuyer" class="input-label">First-Time Home Buyer?</label>
                                <input type="checkbox" id="cc_firstTimeBuyer" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500">
                            </div>
                             <div class="mt-6 text-center">
                                <button id="cc_generateReportBtn" class="btn-primary w-full">Generate Closing Costs Report</button>
                            </div>
                        </div>
                    </div>
                     <div class="card p-6">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Estimated Closing Costs</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between"><span>Land Transfer Tax:</span><span id="cc_ltt" class="font-semibold">$0</span></div>
                            <div class="flex justify-between"><span>Legal Fees (Est.):</span><span id="cc_legal" class="font-semibold">$0</span></div>
                            <div class="flex justify-between"><span>Title Insurance (Est.):</span><span id="cc_title" class="font-semibold">$0</span></div>
                            <div class="flex justify-between"><span>Other (Est.):</span><span id="cc_other" class="font-semibold">$0</span></div>
                            <hr class="my-2">
                            <div class="flex justify-between text-xl font-bold"><span>Total Estimated Costs:</span><span id="cc_total" class="text-blue-700">$0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Amortization Schedule Tab -->
            <div id="amortization-schedule" class="tab-content">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-700">Amortization Schedule</h2>
                        <button id="as_generateReportBtn" class="btn-primary">Generate Printable Schedule</button>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-2">Year</th>
                                    <th class="p-2">Principal Paid</th>
                                    <th class="p-2">Interest Paid</th>
                                    <th class="p-2">Total Paid</th>
                                    <th class="p-2">Ending Balance</th>
                                </tr>
                            </thead>
                            <tbody id="as_tableBody">
                                <!-- Rows will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 py-6 border-t border-gray-300">
            <p class="text-gray-600">This calculator was prepared for you by</p>
            <p class="text-xl font-semibold text-gray-800 mt-1">Ken Morgan, Realtor</p>
        </footer>
    </div>

    <script>
        // --- IMAGE CONFIGURATION ---
        // This array controls the images that appear in the header of the page and the PDF report.
        const headerImages = [
            {
                id: 'logoImage', // A unique ID for the image
                src: 'https://i.imgur.com/j8O38d9.png', // The direct URL to your image
                alt: 'Ken Morgan Logo', // Alt text for the image
                style: 'max-h-24 object-contain', // Tailwind CSS classes for styling
                pdf: { x: 15, y: 15, w: 40, h: 0 } // Set h: 0 to maintain aspect ratio
            },
            {
                id: 'qrImage',
                src: 'https://i.imgur.com/UEDKhZF.png',
                alt: 'QR Code',
                style: 'max-h-24 w-24 object-contain',
                pdf: { x: 170, y: 15, w: 25, h: 25 } // Keep w and h the same for square images
            }
        ];

        // --- DOM Elements ---
        const elements = {
            // Payment Calculator
            pc_propertyAddress: document.getElementById('pc_propertyAddress'),
            pc_purchasePrice: document.getElementById('pc_purchasePrice'),
            pc_purchasePriceSlider: document.getElementById('pc_purchasePriceSlider'),
            pc_downPayment: document.getElementById('pc_downPayment'),
            pc_downPaymentValue: document.getElementById('pc_downPaymentValue'),
            pc_minDownPaymentText: document.getElementById('pc_minDownPaymentText'),
            pc_interestRate: document.getElementById('pc_interestRate'),
            pc_amortization: document.getElementById('pc_amortization'),
            pc_propertyTaxes: document.getElementById('pc_propertyTaxes'),
            pc_monthlyUtilities: document.getElementById('pc_monthlyUtilities'),
            pc_condoFees: document.getElementById('pc_condoFees'),
            pc_generateReportBtn: document.getElementById('pc_generateReportBtn'),
            pc_totalMonthlyPayment: document.getElementById('pc_totalMonthlyPayment'),
            pc_requiredIncome: document.getElementById('pc_requiredIncome'),
            pc_downPaymentAmount: document.getElementById('pc_downPaymentAmount'),
            pc_initialMortgage: document.getElementById('pc_initialMortgage'),
            pc_cmhcPremium: document.getElementById('pc_cmhcPremium'),
            pc_totalFinanced: document.getElementById('pc_totalFinanced'),
            pc_piPayment: document.getElementById('pc_piPayment'),
            pc_monthlyTaxes: document.getElementById('pc_monthlyTaxes'),
            pc_monthlyCondo: document.getElementById('pc_monthlyCondo'),
            
            // Affordability Calculator
            ac_annualIncome: document.getElementById('ac_annualIncome'),
            ac_monthlyDebts: document.getElementById('ac_monthlyDebts'),
            ac_downPaymentAmount: document.getElementById('ac_downPaymentAmount'),
            ac_generateReportBtn: document.getElementById('ac_generateReportBtn'),
            ac_maxPurchasePrice: document.getElementById('ac_maxPurchasePrice'),

            // Closing Costs
            cc_purchasePrice: document.getElementById('cc_purchasePrice'),
            cc_firstTimeBuyer: document.getElementById('cc_firstTimeBuyer'),
            cc_generateReportBtn: document.getElementById('cc_generateReportBtn'),
            cc_ltt: document.getElementById('cc_ltt'),
            cc_legal: document.getElementById('cc_legal'),
            cc_title: document.getElementById('cc_title'),
            cc_other: document.getElementById('cc_other'),
            cc_total: document.getElementById('cc_total'),

            // Amortization Schedule
            as_tableBody: document.getElementById('as_tableBody'),
            as_generateReportBtn: document.getElementById('as_generateReportBtn'),

            // General
            firstTimeBuyer: document.getElementById('firstTimeBuyer'), // Used by LTT calc
        };

        // --- Chart Initialization ---
        const ctx = document.getElementById('paymentChart').getContext('2d');
        let paymentChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: ['Principal & Interest', 'Property Tax', 'Condo Fees', 'Utilities'], datasets: [{ data: [1, 1, 1, 1], backgroundColor: ['#3182ce', '#63b3ed', '#90cdf4', '#a3bfd7'], borderColor: '#ffffff', borderWidth: 2 }] },
            options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Monthly Payment Breakdown', font: { size: 16 } } } }
        });

        // --- Calculation Logic ---
        const formatCurrency = (num, includeDecimals = true) => {
            if (typeof num !== 'number' || !isFinite(num)) {
                return '$ -';
            }
            const options = { 
                style: 'currency', 
                currency: 'CAD',
                minimumFractionDigits: includeDecimals ? 2 : 0,
                maximumFractionDigits: includeDecimals ? 2 : 0,
            };
            return new Intl.NumberFormat('en-CA', options).format(num);
        }
        
        function getMinDownPayment(price) {
            if (price <= 500000) return price * 0.05;
            if (price < 1500000) return (500000 * 0.05) + ((price - 500000) * 0.10);
            return price * 0.20;
        }

        function calculateCMHC(loanAmount, downPaymentPercent) {
            if (downPaymentPercent >= 20) return 0;
            const ltv = 100 - downPaymentPercent;
            if (ltv > 95) return Infinity;
            if (ltv > 90.01) return loanAmount * 0.0400;
            if (ltv > 85.01) return loanAmount * 0.0310;
            if (ltv > 80.01) return loanAmount * 0.0280;
            return 0;
        }
        
        function calculateMonthlyPI(principal, annualRate, years) {
            if (principal <= 0) return 0;
            const monthlyRate = (annualRate / 100) / 12;
            const numberOfPayments = years * 12;
            if (monthlyRate === 0) return principal / numberOfPayments;
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
        }

        function calculateLTT(price, isFirstTime) {
            let tax = 0;
            if (price > 400000) tax += (price - 400000) * 0.02;
            if (price > 250000) tax += (Math.min(price, 400000) - 250000) * 0.015;
            if (price > 55000) tax += (Math.min(price, 250000) - 55000) * 0.01;
            tax += Math.min(price, 55000) * 0.005;
            if (isFirstTime) tax = Math.max(0, tax - 4000);
            return tax;
        }

        // --- Main Calculation Functions ---

        function calculatePayment() {
            const price = parseFloat(elements.pc_purchasePrice.value) || 0;
            let downPaymentPercent = parseFloat(elements.pc_downPayment.value) || 0;
            const annualRate = parseFloat(elements.pc_interestRate.value) || 0;
            const amortizationYears = parseInt(elements.pc_amortization.value, 10);
            const annualTaxes = parseFloat(elements.pc_propertyTaxes.value) || 0;
            const monthlyCondo = parseFloat(elements.pc_condoFees.value) || 0;
            const monthlyUtilities = parseFloat(elements.pc_monthlyUtilities.value) || 0;

            const minDownPaymentAmount = getMinDownPayment(price);
            const minDownPaymentPercent = (minDownPaymentAmount / price) * 100;
            
            elements.pc_downPayment.min = minDownPaymentPercent.toFixed(1);
            if (downPaymentPercent < minDownPaymentPercent) {
                downPaymentPercent = minDownPaymentPercent;
                elements.pc_downPayment.value = minDownPaymentPercent.toFixed(1);
            }
            elements.pc_minDownPaymentText.textContent = `Minimum down payment for this price is ${formatCurrency(minDownPaymentAmount)} (${minDownPaymentPercent.toFixed(2)}%).`;

            const downPaymentAmount = price * (downPaymentPercent / 100);
            const initialMortgage = price - downPaymentAmount;
            const cmhcPremium = calculateCMHC(initialMortgage, downPaymentPercent);
            const totalFinanced = initialMortgage + cmhcPremium;
            const piPayment = calculateMonthlyPI(totalFinanced, annualRate, amortizationYears);
            const monthlyTaxes = annualTaxes / 12;
            const totalMonthlyPayment = piPayment + monthlyTaxes + monthlyCondo + monthlyUtilities;
            const stressTestRate = Math.max(5.25, annualRate + 2);
            const stressTestPI = calculateMonthlyPI(totalFinanced, stressTestRate, amortizationYears);
            const gdsCosts = stressTestPI + monthlyTaxes + monthlyUtilities + (monthlyCondo * 0.5);
            const requiredIncome = (gdsCosts * 12) / 0.39;

            elements.pc_downPaymentValue.textContent = `${downPaymentPercent.toFixed(1)}%`;
            elements.pc_downPaymentAmount.textContent = formatCurrency(downPaymentAmount);
            elements.pc_initialMortgage.textContent = formatCurrency(initialMortgage);
            elements.pc_cmhcPremium.textContent = formatCurrency(cmhcPremium);
            elements.pc_totalFinanced.textContent = formatCurrency(totalFinanced);
            elements.pc_piPayment.textContent = `${formatCurrency(piPayment)}/mo`;
            elements.pc_monthlyTaxes.textContent = `${formatCurrency(monthlyTaxes)}/mo`;
            elements.pc_monthlyCondo.textContent = `${formatCurrency(monthlyCondo)}/mo`;
            elements.pc_totalMonthlyPayment.textContent = formatCurrency(totalMonthlyPayment);
            elements.pc_requiredIncome.textContent = formatCurrency(requiredIncome);

            paymentChart.data.datasets[0].data = [piPayment, monthlyTaxes, monthlyCondo, monthlyUtilities];
            paymentChart.update();
        }

        function calculateAffordability() {
            const annualIncome = parseFloat(elements.ac_annualIncome.value) || 0;
            const monthlyDebts = parseFloat(elements.ac_monthlyDebts.value) || 0;
            const downPayment = parseFloat(elements.ac_downPaymentAmount.value) || 0;
            
            const stressTestRate = 5.25; // Use a standard stress test rate for affordability
            const gdsLimit = 0.39;
            const tdsLimit = 0.44;
            const propertyTaxEstimate = 0.01; // 1% of home value
            const heatingEstimate = 75;

            // TDS calculation
            const maxMonthlyHousingCostByTDS = (annualIncome / 12 * tdsLimit) - monthlyDebts;
            
            // GDS calculation
            const maxMonthlyHousingCostByGDS = (annualIncome / 12 * gdsLimit);

            const maxAffordableMonthlyPayment = Math.min(maxMonthlyHousingCostByGDS, maxMonthlyHousingCostByTDS);
            
            // Back-calculate max mortgage
            let maxMortgage = 0;
            if (maxAffordableMonthlyPayment > 0) {
                const monthlyRate = (stressTestRate / 100) / 12;
                const numberOfPayments = 25 * 12;
                maxMortgage = (maxAffordableMonthlyPayment - heatingEstimate) * (Math.pow(1 + monthlyRate, numberOfPayments) - 1) / (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments));
            }

            const maxHomePrice = maxMortgage + downPayment;
            elements.ac_maxPurchasePrice.textContent = formatCurrency(maxHomePrice);
        }

        function calculateClosingCosts() {
            const price = parseFloat(elements.cc_purchasePrice.value) || 0;
            const isFirstTime = elements.cc_firstTimeBuyer.checked;

            const ltt = calculateLTT(price, isFirstTime);
            const legalFees = 1500;
            const titleInsurance = 400;
            const other = 500;
            const total = ltt + legalFees + titleInsurance + other;

            elements.cc_ltt.textContent = formatCurrency(ltt);
            elements.cc_legal.textContent = formatCurrency(legalFees);
            elements.cc_title.textContent = formatCurrency(titleInsurance);
            elements.cc_other.textContent = formatCurrency(other);
            elements.cc_total.textContent = formatCurrency(total);
        }

        function generateAmortizationSchedule() {
            const price = parseFloat(elements.pc_purchasePrice.value) || 0;
            const downPaymentPercent = parseFloat(elements.pc_downPayment.value) || 0;
            const annualRate = parseFloat(elements.pc_interestRate.value) || 0;
            const amortizationYears = parseInt(elements.pc_amortization.value, 10);
            
            const downPaymentAmount = price * (downPaymentPercent / 100);
            const initialMortgage = price - downPaymentAmount;
            const cmhcPremium = calculateCMHC(initialMortgage, downPaymentPercent);
            const totalFinanced = initialMortgage + cmhcPremium;
            const monthlyPayment = calculateMonthlyPI(totalFinanced, annualRate, amortizationYears);

            let balance = totalFinanced;
            let yearlyData = [];
            
            for (let year = 1; year <= amortizationYears; year++) {
                let yearlyPrincipal = 0;
                let yearlyInterest = 0;
                for (let month = 1; month <= 12; month++) {
                    const interestForMonth = balance * (annualRate / 100 / 12);
                    const principalForMonth = monthlyPayment - interestForMonth;
                    balance -= principalForMonth;
                    yearlyPrincipal += principalForMonth;
                    yearlyInterest += interestForMonth;
                }
                yearlyData.push({
                    year,
                    principal: yearlyPrincipal,
                    interest: yearlyInterest,
                    total: yearlyPrincipal + yearlyInterest,
                    balance: balance > 0 ? balance : 0
                });
            }
            
            elements.as_tableBody.innerHTML = yearlyData.map(row => `
                <tr class="border-b">
                    <td class="p-2">${row.year}</td>
                    <td class="p-2">${formatCurrency(row.principal)}</td>
                    <td class="p-2">${formatCurrency(row.interest)}</td>
                    <td class="p-2">${formatCurrency(row.total)}</td>
                    <td class="p-2">${formatCurrency(row.balance)}</td>
                </tr>
            `).join('');

            return yearlyData;
        }

        // --- PDF Report Generation ---
        function generatePaymentReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'letter');

            const price = parseFloat(elements.pc_purchasePrice.value) || 0;
            const address = elements.pc_propertyAddress.value || 'N/A';
            const annualRate = parseFloat(elements.pc_interestRate.value) || 0;
            const amortizationYears = parseInt(elements.pc_amortization.value, 10);
            const annualTaxes = parseFloat(elements.pc_propertyTaxes.value) || 0;
            const monthlyCondo = parseFloat(elements.pc_condoFees.value) || 0;
            const monthlyUtilities = parseFloat(elements.pc_monthlyUtilities.value) || 0;
            
            const minDownPercent = (getMinDownPayment(price) / price) * 100;
            let scenarioPercentages;

            if (minDownPercent <= 5) {
                scenarioPercentages = [5, 10, 20, 50];
            } else {
                scenarioPercentages = [minDownPercent, 10, 20, 50];
            }
            
            const uniqueScenarios = [...new Set(scenarioPercentages)].sort((a,b) => a-b);

            const applicableScenarios = uniqueScenarios
                .filter(p => p >= minDownPercent)
                .map(dpPercent => {
                    const dpAmount = price * (dpPercent / 100);
                    const mortgage = price - dpAmount;
                    const cmhc = calculateCMHC(mortgage, dpPercent);
                    const totalFinanced = mortgage + cmhc;
                    const piPayment = calculateMonthlyPI(totalFinanced, annualRate, amortizationYears);
                    const totalMonthly = piPayment + (annualTaxes / 12) + monthlyCondo + monthlyUtilities;
                    const stressTestRate = Math.max(5.25, annualRate + 2);
                    const stressTestPI = calculateMonthlyPI(totalFinanced, stressTestRate, amortizationYears);
                    const gdsCosts = stressTestPI + (annualTaxes / 12) + monthlyUtilities + (monthlyCondo * 0.5);
                    const requiredIncome = (gdsCosts * 12) / 0.39;

                    return {
                        "Scenario Title": dpPercent < 20 ? "High Ratio" : "Conventional",
                        "Down Payment %": `${dpPercent.toFixed(2)}%`,
                        "Down Payment Amount": formatCurrency(dpAmount), "First Mortgage": formatCurrency(mortgage), "CMHC Premium": formatCurrency(cmhc), "Total Financing": formatCurrency(totalFinanced),
                        "Principal & Interest": formatCurrency(piPayment), "Monthly Property Tax": formatCurrency(annualTaxes / 12), "Monthly Utilities": formatCurrency(monthlyUtilities), "Total Monthly Payment": formatCurrency(totalMonthly), "Required Gross Income": formatCurrency(requiredIncome)
                    };
                });

            // --- Drawing PDF ---
            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();
            const leftMargin = 15;
            let y = 20;

            headerImages.forEach(imgData => {
                const imgElement = document.getElementById(imgData.id);
                if (imgElement && imgElement.src && imgElement.src.includes('http') && imgElement.complete) {
                    try {
                        const imgProps = doc.getImageProperties(imgElement);
                        const aspectRatio = imgProps.width / imgProps.height;
                        let w = imgData.pdf.w;
                        let h = imgData.pdf.h;
                        
                        if (w > 0 && h === 0) { 
                            h = w / aspectRatio;
                            if (h > 20) { 
                                h = 20;
                                w = h * aspectRatio;
                            }
                        } else if (h > 0 && w === 0) {
                             w = h * aspectRatio;
                        }

                        doc.addImage(imgElement, 'JPEG', imgData.pdf.x, imgData.pdf.y, w, h);
                    } catch (e) { console.error("Error adding image to PDF:", e); }
                }
            });

            doc.setFont('Times', 'italic');
            doc.setFontSize(24).setTextColor(41, 128, 185);
            doc.text(address, pageW / 2, y, { align: 'center' });
            y += 12;
            
            doc.setFont('Helvetica', 'bold').setFontSize(18).setTextColor(100);
            doc.text(`Purchase Price: ${formatCurrency(price)}`, pageW / 2, y, { align: 'center' });
            y += 8;
            doc.setFont('Helvetica', 'normal').setFontSize(10).setTextColor(120,120,120);
            doc.text(`Based on a ${annualRate.toFixed(2)}% interest rate and a ${amortizationYears}-year amortization.`, pageW / 2, y, { align: 'center' });
            y += 8;


            const labelColWidth = 55;
            const valueColWidth = (pageW - leftMargin * 2 - labelColWidth) / applicableScenarios.length;
            const colStarts = applicableScenarios.map((_, i) => leftMargin + labelColWidth + (i * valueColWidth));
            
            const rowLabels = Object.keys(applicableScenarios[0]);
            rowLabels.forEach((label, i) => {
                if (label === "Scenario Title") {
                    doc.setFillColor(44, 62, 80);
                    doc.rect(leftMargin, y - 5, pageW - (leftMargin * 2), 10, 'F');
                }
                
                doc.setFontSize(9);
                doc.setTextColor(52, 73, 94);

                if (label === "Total Monthly Payment" || label === "Required Gross Income") doc.setFont('Helvetica', 'bold');
                else doc.setFont('Helvetica', 'normal');

                if (label !== "Scenario Title") {
                    doc.text(label, leftMargin + 1, y);
                }

                applicableScenarios.forEach((scenario, j) => {
                    if (label === "Scenario Title") {
                        doc.setFont('Helvetica', 'bold').setTextColor(255, 255, 255);
                    } else {
                        doc.setFont('Helvetica', 'normal').setTextColor(52, 73, 94);
                    }
                    doc.text(scenario[label], colStarts[j] + valueColWidth / 2, y, { align: 'center' });
                });
                y += (i === 0) ? 12 : 8;
            });
            const endOfTableY = y;

            // --- Charts Section ---
            const chartSectionHeight = 60; 
            const footerStartY = pageH - 60;
            const availableSpace = footerStartY - endOfTableY;
            let chartSectionTop = endOfTableY + (availableSpace - chartSectionHeight) / 2;
            
            doc.setDrawColor(220, 220, 220).line(leftMargin, chartSectionTop, pageW - leftMargin, chartSectionTop);
            chartSectionTop += 8;
            
            doc.setFont('Helvetica', 'bold').setFontSize(12).setTextColor(0,0,0);
            doc.text("Visual Comparison", pageW/2, chartSectionTop, {align: 'center'});

            const chartH = 40;
            const chartsY = chartSectionTop + chartSectionHeight - chartH - 5;
            
            const chartW = (pageW - leftMargin * 2 - 15) / 2;
            const reportScenarios = applicableScenarios;

            // Chart 1: Monthly Payment
            const paymentValues = reportScenarios.map(s => parseFloat(s["Total Monthly Payment"].replace(/[^0-9.-]+/g,"")));
            const maxPayment = Math.ceil(Math.max(...paymentValues) / 500) * 500;
            doc.setFont('Helvetica', 'normal').setFontSize(7).setTextColor(120, 120, 120);
            doc.text(formatCurrency(maxPayment, false), leftMargin - 2, chartsY + 3, { align: 'right' });
            doc.text(formatCurrency(0, false), leftMargin - 2, chartsY + chartH, { align: 'right' });
            reportScenarios.forEach((scenario, i) => {
                const barHeight = maxPayment > 0 ? (paymentValues[i] / maxPayment) * chartH : 0;
                const barX = leftMargin + (chartW / reportScenarios.length) * i + (chartW / reportScenarios.length - 15) / 2;
                const barColors = ['#2980B9', '#3498DB', '#5DADE2', '#85C1E9'];
                doc.setFillColor(barColors[i % barColors.length]);
                doc.rect(barX, chartsY + chartH - barHeight, 15, barHeight, 'F');
                doc.setFont('Helvetica', 'bold').setFontSize(8).setTextColor(44, 62, 80).text(formatCurrency(paymentValues[i], false), barX + 7.5, chartsY + chartH - barHeight - 2, {align: 'center'});
                doc.setFont('Helvetica', 'normal').setFontSize(7).setTextColor(0,0,0).text(scenario["Down Payment %"], barX + 7.5, chartsY + chartH + 4, {align: 'center'});
            });

            // Chart 2: Total Mortgage
            const mortgageChartX = leftMargin + chartW + 15;
            const mortgageValues = reportScenarios.map(s => parseFloat(s["Total Financing"].replace(/[^0-9.-]+/g,"")));
            const maxMortgage = Math.ceil(Math.max(...mortgageValues) / 100000) * 100000;
            doc.setFont('Helvetica', 'normal').setFontSize(7).setTextColor(120, 120, 120);
            doc.text(formatCurrency(maxMortgage, false), mortgageChartX - 2, chartsY + 3, { align: 'right' });
            doc.text(formatCurrency(0, false), mortgageChartX - 2, chartsY + chartH, { align: 'right' });
            reportScenarios.forEach((scenario, i) => {
                const barHeight = maxMortgage > 0 ? (mortgageValues[i] / maxMortgage) * chartH : 0;
                const barX = mortgageChartX + (chartW / reportScenarios.length) * i + (chartW / reportScenarios.length - 15) / 2;
                const barColors = ['#2980B9', '#3498DB', '#5DADE2', '#85C1E9'];
                doc.setFillColor(barColors[i % barColors.length]);
                doc.rect(barX, chartsY + chartH - barHeight, 15, barHeight, 'F');
                doc.setFont('Helvetica', 'bold').setFontSize(8).setTextColor(44, 62, 80).text(formatCurrency(mortgageValues[i], false), barX + 7.5, chartsY + chartH - barHeight - 2, {align: 'center'});
                doc.setFont('Helvetica', 'normal').setFontSize(7).setTextColor(0,0,0).text(scenario["Down Payment %"], barX + 7.5, chartsY + chartH + 4, {align: 'center'});
            });

            // --- Footer Section ---
            doc.setDrawColor(220, 220, 220).line(leftMargin, footerStartY, pageW - leftMargin, footerStartY);
            
            // Key Considerations
            const considerationsY = footerStartY + 8;
            doc.setFont('Helvetica', 'bold').setFontSize(11).setTextColor(0,0,0);
            doc.text("Key Considerations", leftMargin, considerationsY);
            
            const minDownPaymentAmount = getMinDownPayment(price);
            const considerationsText = [
                `Minimum Down Payment: For this property, a minimum down payment of ${minDownPercent.toFixed(2)}% (${formatCurrency(minDownPaymentAmount)}) is required.`,
                "Mortgage Default Insurance (e.g. CMHC): If your down payment is less than 20%, you must get mortgage default insurance. The premium is typically added to your mortgage amount.",
                "Benefit of 20% Down: Putting down 20% or more avoids the cost of mortgage default insurance, potentially saving you thousands and leading to better mortgage rates.",
                "Amortization Period: As of Dec 15, 2024, first-time homebuyers purchasing new construction may qualify for a 30-year amortization period, even with less than 20% down."
            ].join(" ");
            doc.setFont('Helvetica', 'normal').setFontSize(8);
            const considerationsLines = doc.splitTextToSize(considerationsText, pageW - (leftMargin * 2) - 65);
            doc.text(considerationsLines, leftMargin, considerationsY + 5, { lineHeightFactor: 1.5 });
            const considerationsHeight = (doc.getTextDimensions(considerationsLines).h) + 4;

            // Contact Info & Call to Action
            const contactBlockHeight = considerationsHeight > 32 ? considerationsHeight : 32;
            const contactBlockY = footerStartY + 5;
            const contactX = pageW - leftMargin - 60;
            doc.setFillColor(245, 248, 252);
            doc.setDrawColor(220, 220, 220);
            doc.rect(contactX, contactBlockY, 60, contactBlockHeight, 'FD');
            doc.setFont('Helvetica', 'bold').setFontSize(12).setTextColor(44, 62, 80);
            doc.text("Ready for the next step?", contactX + 30, contactBlockY + 8, {align: 'center'});
            doc.setFont('Helvetica', 'bold').setFontSize(14).setTextColor(41, 128, 185);
            doc.text("KEN MORGAN", contactX + 30, contactBlockY + 16, {align: 'center'});
            doc.setFont('Helvetica', 'normal').setFontSize(9).setTextColor(52, 73, 94);
            doc.text("Call or Text: 905.630.1225", contactX + 30, contactBlockY + 22, {align: 'center'});
            doc.text("sales@kenmorgan.ca | kenmorgan.ca", contactX + 30, contactBlockY + 27, {align: 'center'});

            // Disclaimer
            const disclaimer = "This report is for estimation purposes only and does not constitute a loan offer or approval. All calculations, rates, and figures are subject to change and must be verified with a qualified, independent mortgage professional. Figures do not include costs for heating, hydro, insurance, or other property-specific expenses. Errors & Omissions Excepted (E&OE).";
            doc.setFontSize(7).setTextColor(150, 150, 150);
            doc.text(disclaimer, pageW / 2, pageH - 10, { align: 'center', maxWidth: pageW - 20 });
            
            doc.save(`Financing-Report-${address.replace(/ /g, '-')}.pdf`);
        }

        // --- Other Report Generation Functions (Placeholders for now) ---
        function generateAffordabilityReport() { alert("Affordability Report generation coming soon!"); }
        function generateClosingCostReport() { alert("Closing Cost Report generation coming soon!"); }
        function generateAmortizationReport() { 
            const yearlyData = generateAmortizationSchedule();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Amortization Schedule", 15, 15);
            doc.autoTable({
                head: [['Year', 'Principal Paid', 'Interest Paid', 'Total Paid', 'Ending Balance']],
                body: yearlyData.map(row => [row.year, formatCurrency(row.principal), formatCurrency(row.interest), formatCurrency(row.total), formatCurrency(row.balance)]),
            });
            doc.save('Amortization-Schedule.pdf');
        }


        function renderHeaderImages() {
            const container = document.getElementById('header-images-container');
            if (!container) return;
            container.innerHTML = ''; // Clear existing images
            
            headerImages.forEach((imgData, index) => {
                const img = document.createElement('img');
                img.id = imgData.id;
                img.src = imgData.src;
                img.alt = imgData.alt;
                img.className = imgData.style;
                img.crossOrigin = "anonymous";

                const placeholder = document.createElement('div');
                placeholder.className = 'bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 font-medium text-center p-2';
                placeholder.style.cssText = `display: none; height: 96px; width: ${imgData.id.includes('qr') ? '96px' : '192px'};`;
                placeholder.textContent = imgData.alt;

                img.onerror = () => {
                    img.style.display = 'none';
                    placeholder.style.display = 'flex';
                };
                
                container.appendChild(img);
                container.appendChild(placeholder);
            });
        }

        function setupTabs() {
            const tabNav = document.getElementById('tab-nav');
            const tabContents = document.getElementById('tab-content-container').children;

            tabNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const tabId = e.target.dataset.tab;

                    // Update active tab
                    for (const tab of tabNav.children) {
                        tab.classList.remove('active');
                    }
                    e.target.classList.add('active');

                    // Update active content
                    for (const content of tabContents) {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    }
                }
            });
        }


        // --- Event Listeners ---
        const allInputs = document.querySelectorAll('.input-field, .slider, input[type="checkbox"]');
        allInputs.forEach(input => {
            input.addEventListener('input', () => {
                calculatePayment();
                calculateAffordability();
                calculateClosingCosts();
                generateAmortizationSchedule();
            });
        });
        
        elements.pc_generateReportBtn.addEventListener('click', generatePaymentReport);
        elements.ac_generateReportBtn.addEventListener('click', generateAffordabilityReport);
        elements.cc_generateReportBtn.addEventListener('click', generateClosingCostReport);
        elements.as_generateReportBtn.addEventListener('click', generateAmortizationReport);

        elements.pc_purchasePrice.addEventListener('input', () => elements.pc_purchasePriceSlider.value = elements.pc_purchasePrice.value);
        elements.pc_purchasePriceSlider.addEventListener('input', () => elements.pc_purchasePrice.value = elements.pc_purchasePriceSlider.value);

        window.addEventListener('load', () => {
            renderHeaderImages();
            setupTabs();
            calculatePayment();
            calculateAffordability();
            calculateClosingCosts();
            generateAmortizationSchedule();
        });

    </script>
</body>
<!--
    INSTRUCTIONS FOR ADDING AND CUSTOMIZING YOUR HEADER IMAGES

    This calculator uses a JavaScript array called 'headerImages' to manage the images that appear at the top of the page and in the PDF report.
    You can find this array at the top of the <script> tag (around line 245).

    **How to Edit Your Images:**

    1.  **Get Direct Image Links:**
        - Upload your images (Logo, QR Code, etc.) to a public hosting service like Imgur (https://imgur.com/upload).
        - For each image, right-click on it and select "Copy Image Address". This gives you a direct link that ends in .jpg, .png, etc.

    2.  **Modify the `headerImages` Array:**
        - **To change an image:** Replace the `src` value with your new Imgur link.
        - **To add a new image:** Copy one of the existing blocks (from the opening `{` to the closing `}`), paste it into the array, and update the `id`, `src`, `alt`, `style`, and `pdf` properties.
        - **To remove an image:** Delete its entire block from the array.
        - **To reorder images:** Change the order of the blocks within the array.

    **Understanding the Properties:**

    - `id`: A unique name for the image (e.g., 'logoImage').
    - `src`: The direct URL to your image from Imgur.
    - `alt`: A short description of the image.
    - `style`: Tailwind CSS classes to control the image's appearance on the webpage.
        - `max-h-24`: Sets the maximum height to 6rem (96px). The width will adjust automatically.
        - `object-contain`: Ensures the image scales down to fit without being stretched or cropped.
        - You can add other classes here if needed (e.g., `w-24` to set a fixed width for a QR code).
    - `pdf`: An object that controls the image's position and size in the generated PDF.
        - `x`, `y`: The position in millimeters from the top-left corner of the page.
        - `w`, `h`: The width and height of the image in millimeters. 
        - **IMPORTANT:** To maintain the image's aspect ratio, set either `w` or `h` to `0`. For example, `h: 0` will automatically calculate the height based on the width you provide. For square images like QR codes, you can set both `w` and `h` to the same value.

    **Example `headerImages` Array:**

    const headerImages = [
        {
            id: 'logoImage',
            src: 'https://i.imgur.com/j8O38d9.png', // Your logo URL
            alt: 'Ken Morgan Logo',
            style: 'max-h-24 object-contain',
            pdf: { x: 15, y: 15, w: 40, h: 0 } // Height is auto-calculated
        },
        {
            id: 'qrImage',
            src: 'https://i.imgur.com/UEDKhZF.png', // Your QR code URL
            alt: 'QR Code',
            style: 'max-h-24 w-24 object-contain',
            pdf: { x: 170, y: 15, w: 25, h: 25 } // Width and height are fixed
        }
    ];
-->
</html>
